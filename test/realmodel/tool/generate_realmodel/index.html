<html>
  <head>
    <meta charset="utf-8">
    <title>Onnx Importer Test</title>
  </head>
  <body>
    <script src="../../../dist/webml-polyfill.js"></script>
    <script src="../../third_party/protobuf.min.js"></script>
    <script src="../../util/base.js"></script>
    <script src="onnx.js"></script>
    <script src="OnnxModelUtils.js"></script>
    <script src="OnnxModelImporter.js"></script>
    <script>
    var getLayerFlag = true;
    var jsonlist = {};
    jsonlist['Source'] = {};
    jsonlist['Case'] = {};

     window.onload = async function() {
      async function loadUrl(url) {
        return new Promise(resolve => {
          let request = new XMLHttpRequest();
          request.open('GET', url, true);
          request.responseType = 'arraybuffer';
          request.onload = _ => {
            if (request.readyState === 4 && request.status === 200)
              resolve(new Uint8Array(request.response));
          };
          request.send();
        });
      }
      
      async function downloadjson(data, filename) {
        if (!data) {
          console.error("Console.save : No data");
          return;
        }
        if (!filename) filename = "layerdata.json";
        if (typeof data === "object") {
          data = JSON.stringify(data);
        }
        var blob = new Blob([data], {type: 'text/json'}),
            e = document.createEvent('MouseEvents'),
            a = document.createElement('a');
        a.download = filename;
        a.href = window.URL.createObjectURL(blob);
        a.dataset.downloadurl = ['text/json', a.download, a.href].join(':');
        e.initMouseEvent('click', true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
        a.dispatchEvent(e)
      }

      async function loadTensor(tensorFile) {
        let result = await loadUrl(tensorFile);
        if (onnx.TensorProto.verify(result))
          throw new Error(`Invalid tensor`);
        let tensor = onnx.TensorProto.decode(result);
        return getTensorData(tensor);
      }

      function almostEqual(a, b, episilon=1e-5) {
        return Math.abs(a - b) < episilon;
      }
      
      const modelName = 'squeezenet1.1';
      const modelFile = `../../../test/realmodel/tool/generate_realmodel/model/${modelName}/${modelName}.onnx`;
      let input = await loadTensor(`../../../test/realmodel/tool/generate_realmodel/model/${modelName}/test_data_set_1/input_0.pb`);
      let expect = await loadTensor(`../../../test/realmodel/tool/generate_realmodel/model/${modelName}/test_data_set_1/output_0.pb`);
      let result = await loadUrl(modelFile);
      if (onnx.ModelProto.verify(result))
        throw new Error(`Invalid model`);
      let onnxModel = onnx.ModelProto.decode(result);
      let wasmGen = new OnnxModelImporter({rawModel: onnxModel, backend: 'WASM', prefer: 'fast'}).layerIterator([input]); 

      while (true) {
        let wasmnext = await wasmGen.next();
        if (wasmnext.done) {
          console.log(jsonlist)
          break;
        }
        if (getLayerFlag) {
          jsonlist['Source'][wasmnext.value.outputName] = wasmnext.value.tensor;
          jsonlist['Source']['data'] = input; 
        }      
      }
       if (getLayerFlag) await downloadjson(jsonlist, `${modelName}.json`);
    }
    </script>
  </body>
</html>
